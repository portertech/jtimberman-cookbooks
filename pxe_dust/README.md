Description
===========
Configures a tftpd server for serving Ubuntu installers over PXE and setting them to run a provided preseed.cfg.

Requirements
============
Written and last tested with Chef 0.10.0 and Ubuntu 10.04 and 10.10. Using the `[apt::cacher]` recipe is highly recommended, but not a requirement.

pxe_dust Data Bag
=================
In order to manage configuration of machines registering themselves with their Chef Server or the Opscode Platform, we will use the `pxe_dust` data bag.

```
% knife data bag create pxe_dust
% knife data bag from file pxe_dust examples/defaults.json
```

Here is an example of the defaults.json:

```json
{
    "id": "defaults",
    "arch": "amd64",
    "version": "lucid",
    },
    "user": {
        "fullname": "Ubuntu",
        "username": "ubuntu",
        "crypted_password": "$6$Trby4Y5R$bi90k7uYY5ImXe5MWGFW9kel2BnMCcYO9EnwngTFIXKG2/nWcLKTJZ3verMFnpFbITI9.eHwZ.HR1UPeKbCAV1"
    }
}
```

Here are currently supported options available for inclusion in the `defaults.json`.:

* `arch`: Architecture of the netboot.tar.gz to use as the source of pxeboot images, default is 'amd64'.

* `version`: Ubuntu version of the netboot.tar.gz to use as the source of pxeboot images, default is 'lucid'.

* `domain`: Default domain for nodes, default is none.
    
* `run_list`: Default run list for nodes, default is none.
    
* `bootstrap`: Optional additional bootstrapping configuration.

    `bootstrap_version_string`: for building specific version of Chef, default is none.

    `http_proxy`: HTTP proxy, default is none.

    `http_proxy_user`: HTTP proxy user, default is none.

    `http_proxy_pass`: HTTP proxy pass, default is none.

    `https_proxy`: HTTPS proxy, default is none.

* `user`: 

    `crypted_password`: SHA512 password for the default user, default 'password'. This may be generated and added to the data bag.

    `fullname`: Full name of the default user, default 'Ubuntu'.

    `username`: Username of the default user, default 'ubuntu'.

Templates
=========

syslinux.cfg.erb
----------------
Sets the boot prompt to automatically run the installer.

txt.cfg.erb
-----------
Sets the URL to the preseed file, architecture, the domain and which interfaces to use.

preseed.cfg.erb
---------------
The preseed file is full of opinions, you will want to update this. If there is a node providing an apt-cacher proxy via the `[apt::cacher]` recipe, it is provided in the preseed.cfg. The initial user and password is configured. The preseed finishes by calling the `chef-bootstrap` script.

chef-bootstrap.sh.erb
---------------------
This is the `preseed/late_command` that bootstraps the node with Chef via gems.

Recipes
=======

Default
-------

The default recipe passes through to `pxe_dust::server`.

Server
------
The server includes the `apache2` and `tftp::server` recipes.

The recipe does the following:

1. Downloads the proper netboot.tar.gz to boot from.
2. Untars it to the `[:tftp][:directory]` directory.
3. Instructs the installer prompt to automatically install.
4. Passes the URL of the preseed.cfg to the installer.
5. Uses the preseed.cfg template to pass in any `apt-cacher` proxies.

Usage
=====
Add the `[pxe_dust::server]` recipe to the server's run_list. Create the `pxe_dust` data bag and update the `defaults.json` item before adding it.

On an Ubuntu system, the password can be generated by installing the `mkpasswd` package and running:

    mkpasswd -m sha-512

The default is the hash of the password `ubuntu`, if you'd like to test. This must be set in the `pxe_dust` data bag to a valid sha-512 hash of the password or you will not be able to log in.

This cookbook does not provide DHCP or bootp to listen for PXE boot requests, this URL will have to be provided by another cookbook or manually. The author had to do this manually on a DD-WRT router.

Side note, for DD-WRT bootp support [this forum post was followed](http://www.dd-wrt.com/phpBB2/viewtopic.php?t=4662). The key syntax was

    dhcp-boot=pxelinux.0,,192.168.1.147

in the section `Additional DNSMasq Options` where the IP address is that of the tftpd server we're configuring here and pxelinux.0 is from the netboot tarball.

License and Author
==================

Author:: Matt Ray <matt@opscode.com>

Author:: Joshua Timberman <joshua@opscode.com>

Copyright:: 2011 Opscode, Inc

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
